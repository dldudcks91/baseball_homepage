{% extends "base.html" %}

{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine-dark.css">

<style>
    :root {
        --bg-primary: #0b0e11;
        --bg-secondary: #1e2329;
        --bg-hover: #2b3139;
        --border-color: #2b3139;
        --text-primary: #eaecef;
        --text-secondary: #848e9c;
        --positive: #0ecb81;
        --negative: #f6465d;
        --accent: #fcd535;
    }

    body {
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .table-container {
        margin: 0;
        padding: 20px;
        background: var(--bg-primary);
    }

    /* 탭 스타일 */
    .nav-tabs {
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-secondary);
        padding: 0 20px;
    }

    .nav-tabs .nav-link {
        color: var(--text-secondary);
        border: none;
        padding: 16px 24px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        border-bottom: 2px solid transparent;
    }

    .nav-tabs .nav-link:hover {
        color: var(--text-primary);
        background: rgba(255, 255, 255, 0.02);
    }

    .nav-tabs .nav-link.active {
        color: var(--accent);
        background: transparent;
        border-bottom: 2px solid var(--accent);
    }

    /* AG Grid 커스텀 스타일 */
    .ag-theme-alpine-dark {
        --ag-background-color: #1e2329;
        --ag-header-background-color: #0b0e11;
        --ag-odd-row-background-color: #1e2329;
        --ag-header-foreground-color: #848e9c;
        --ag-foreground-color: #eaecef;
        --ag-border-color: #2b3139;
        --ag-row-hover-color: #2b3139;
        --ag-selected-row-background-color: #2b3139;
        --ag-font-size: 13px;
        --ag-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .ag-grid-container {
        height: 600px;
        width: 100%;
        margin: 20px 0;
    }

    /* 검색창 스타일 */
    .grid-header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-secondary);
        padding: 10px 20px;
        border-bottom: 1px solid var(--border-color);
    }

    .search-input-wrapper {
        position: relative;
    }

    .quick-filter-input {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 13px;
        width: 250px;
        transition: border-color 0.2s;
    }

    .quick-filter-input:focus {
        outline: none;
        border-color: var(--accent);
    }

    .positive { color: var(--positive) !important; font-weight: 600; }
    .negative { color: var(--negative) !important; font-weight: 600; }

    .percent-box {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    .percent-box.positive { background: rgba(14, 203, 129, 0.1); color: var(--positive); }
    .percent-box.negative { background: rgba(246, 70, 93, 0.1); color: var(--negative); }

    .market-link {
        color: var(--text-primary);
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s;
    }
    .market-link:hover { color: var(--accent); }

    .loading-container {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(11, 14, 17, 0.95);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .loading-spinner {
        width: 60px; height: 60px;
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .update-info, .timer-container {
        color: var(--text-secondary);
        font-size: 12px;
        padding: 4px 0;
    }

    .update-info span { color: var(--accent); font-weight: 600; }

    .favorite-star { cursor: pointer; font-size: 18px; color: var(--text-secondary); transition: all 0.2s; user-select: none; }
    .favorite-star.active { color: var(--accent); }

    .memo-input {
        width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color);
        color: var(--text-primary); padding: 6px 10px; border-radius: 4px; font-size: 12px;
    }
    .memo-input:focus { outline: none; border-color: var(--accent); background: var(--bg-hover); }
</style>

<div id="bithumb-contents">
    <div id="trade_list">
        <ul class="nav nav-tabs" id="tradeTab" role="tablist">
            <li class="nav-item"><a class="nav-link active" id="trade_bithumb_tab" data-toggle="tab" href="#trade_bithumb_contents" role="tab">Bithumb</a></li>
            <li class="nav-item"><a class="nav-link" id="trade_bitget_tab" data-toggle="tab" href="#trade_bitget_contents" role="tab">Bitget</a></li>
        </ul>

        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">데이터를 불러오는 중입니다...</div>
        </div>

        <div class="grid-header-actions">
            <div>
                <div class="timer-container">데이터는 10초에 한번씩 자동으로 업데이트됩니다.</div>
                <div class="update-info">마지막 업데이트: <span id="lastUpdateTime">-</span></div>
            </div>
            <div class="search-input-wrapper">
                <input type="text" id="quickFilter" class="quick-filter-input" placeholder="심볼 또는 메모 검색..." oninput="onFilterTextBoxChanged()">
            </div>
        </div>

        <div class="tab-content" id="tradeTabContent">
            <div class="tab-pane fade show active" id="trade_bithumb_contents" role="tabpanel">
                <div id="gridtradeBithumb" class="ag-theme-alpine-dark ag-grid-container"></div>
            </div>
            <div class="tab-pane fade" id="trade_bitget_contents" role="tabpanel">
                <div id="gridtradeBitget" class="ag-theme-alpine-dark ag-grid-container"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>

<script type="text/javascript">
    let gridApitradeBithumb;
    let gridApitradeBitget;
    let updateInterval;

    let favoritesCache = {};
    let memosCache = {};
    let visitCache = {};

    // 검색 기능 함수
    function onFilterTextBoxChanged() {
        const value = document.getElementById('quickFilter').value;
        if (gridApitradeBithumb) gridApitradeBithumb.setGridOption('quickFilterText', value);
        if (gridApitradeBitget) gridApitradeBitget.setGridOption('quickFilterText', value);
    }

    class MarketCellRenderer {
        init(params) {
            this.eGui = document.createElement('a');
            this.eGui.href = `https://www.bitget.com/futures/usdt/${params.value}USDT`;
            this.eGui.target = '_blank';
            this.eGui.className = 'market-link';
            this.eGui.textContent = params.value;

            this.eGui.addEventListener('click', () => {
                const now = new Date();
                const dateString = now.getFullYear().toString().substring(2) + '.' + 
                                  (now.getMonth() + 1).toString().padStart(2, '0') + '.' + 
                                  now.getDate().toString().padStart(2, '0') + ' ' + 
                                  now.getHours().toString().padStart(2, '0') + ':' + 
                                  now.getMinutes().toString().padStart(2, '0');
                saveVisitDate('bitget', params.value, dateString);
            });
        }
        getGui() { return this.eGui; }
    }

    class PercentCellRenderer {
        init(params) {
            this.eGui = document.createElement('span');
            const value = parseFloat(params.value);
            const absValue = Math.abs(value).toFixed(1);
            const displayValue = value > 0 ? `+${absValue}` : `-${absValue}`;
            this.eGui.className = value > 0 ? 'percent-box positive' : 'percent-box negative';
            this.eGui.textContent = `${displayValue}%`;
        }
        getGui() { return this.eGui; }
    }

    class PriceCellRenderer {
        init(params) {
            this.eGui = document.createElement('span');
            this.eGui.textContent = params.value ? Number(params.value).toLocaleString() : '-';
        }
        getGui() { return this.eGui; }
    }

    const columnDefstradeBithumb = [
        { field: 'market', headerName: '종목', width: 120, pinned: 'left', cellRenderer: MarketCellRenderer, sortable: true, filter: true },
        { field: 'capitalization', headerName: '시가총액', width: 100, cellRenderer: PriceCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price', headerName: '현재가', width: 120, cellRenderer: PriceCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price_ratio_5m', headerName: '5분', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price_ratio_30m', headerName: '30분', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price_ratio_60m', headerName: '60분', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price_ratio_240m', headerName: '240분', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price_ratio_1d', headerName: '1일', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price_ratio_7d', headerName: '7일', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price_ratio_high', headerName: '고점대비', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price_ratio_low', headerName: '저점대비', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'ma_ratio_60_10', headerName: 'MA_60_10', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'ma_ratio_60_50', headerName: 'MA_60_50', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'ma_ratio_60_200', headerName: 'MA_60_200', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'ma_ratio_day_10', headerName: 'MA_1d_10', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'ma_ratio_day_50', headerName: 'MA_1d_50', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'ma_ratio_day_200', headerName: 'MA_1d_200', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' }
    ];

    const columnDefstradeBitget = [
        { 
            field: 'favorite', headerName: '★', width: 60, pinned: 'left',
            cellRenderer: params => {
                const isFavorite = getFavoriteStatus('bitget', params.data.market);
                return `<span class="favorite-star ${isFavorite ? 'active' : ''}" data-market="${params.data.market}">${isFavorite ? '★' : '☆'}</span>`;
            },
            sortable: true, filter: false
        },
        { 
            field: 'memo', headerName: '메모', width: 200, pinned: 'left',
            cellRenderer: params => {
                const memo = getMemo('bitget', params.data.market);
                return `<input type="text" class="memo-input" data-market="${params.data.market}" value="${memo || ''}" placeholder="메모 입력..." onclick="event.stopPropagation()">`;
            },
            sortable: true, filter: false
        },
        { 
            field: 'last_visited_at', headerName: '마지막 방문', width: 140, pinned: 'left',
            cellRenderer: params => {
                const date = getVisitDate('bitget', params.data.market);
                return `<span style="color: var(--text-secondary); font-size: 11px;">${date || '-'}</span>`;
            },
            sortable: true, filter: false
        },
        { field: 'market', headerName: '종목', width: 200, pinned: 'left', cellRenderer: MarketCellRenderer, sortable: true, filter: true },
        { field: 'volume', headerName: '거래대금', cellRenderer: PriceCellRenderer, width: 120, sortable: true, pinned:'left', type: 'numericColumn' },
        { field: 'funding_rate', headerName: '펀딩비', width: 120, cellRenderer: PriceCellRenderer, sortable: true, pinned:'left', type: 'numericColumn' },
        { field: 'price', headerName: '현재가', width: 120, cellRenderer: PriceCellRenderer, sortable: true, pinned:'left', type: 'numericColumn' },
        { field: 'price_ratio_15m', headerName: '15분', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price_ratio_1h', headerName: '1시간', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price_ratio_4h', headerName: '4시간', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price_ratio_1d', headerName: '1일', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price_ratio_7d', headerName: '7일', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price_ratio_14d', headerName: '14일', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price_ratio_high', headerName: '고점1일', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price_ratio_high_7d', headerName: '고점7일', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'price_range_7d', headerName: '범위7일', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'ma_ratio_60_10', headerName: 'MA10', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'ma_ratio_60_20', headerName: 'MA20', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'ma_ratio_60_50', headerName: 'MA50', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'ma_ratio_60_100', headerName: 'MA100', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'ma_ratio_60_200', headerName: 'MA200', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'ma_ratio_60_400', headerName: 'MA400', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
        { field: 'ma_ratio_60_800', headerName: 'MA800', width: 100, cellRenderer: PercentCellRenderer, sortable: true, type: 'numericColumn' },
    ];

    const defaultGridOptions = {
        defaultColDef: { sortable: true, resizable: true, filter: false },
        animateRows: true,
        rowSelection: 'single',
        enableCellTextSelection: true,
        suppressCellFocus: true,
        getRowId: params => params.data.market,
        enableCellChangeFlash: true,
        getRowStyle: params => { if (params.node.rowIndex % 2 === 0) return { background: '#1e2329' }; }
    };

    $(document).ready(function() {
        const gridDivtradeBithumb = document.querySelector('#gridtradeBithumb');
        gridApitradeBithumb = agGrid.createGrid(gridDivtradeBithumb, { ...defaultGridOptions, columnDefs: columnDefstradeBithumb, rowData: [] });
        startAutoUpdate('trade_bithumb');

        $('#trade_bitget_tab').on('click', async function() {
            if (!gridApitradeBitget) {
                const gridDiv = document.querySelector('#gridtradeBitget');
                gridApitradeBitget = agGrid.createGrid(gridDiv, { ...defaultGridOptions, columnDefs: columnDefstradeBitget, rowData: [] });
                await loadUserMemos('bitget');
                gridDiv.addEventListener('click', async function(e) {
                    if (e.target.classList.contains('favorite-star')) {
                        const market = e.target.dataset.market;
                        const isNowFavorite = await toggleFavorite('bitget', market);
                        e.target.textContent = isNowFavorite ? '★' : '☆';
                        e.target.classList.toggle('active', isNowFavorite);
                    }
                });
                gridDiv.addEventListener('input', function(e) {
                    if (e.target.classList.contains('memo-input')) {
                        const market = e.target.dataset.market;
                        const memo = e.target.value;
                        saveMemo('bitget', market, memo);
                    }
                });
            }
            startAutoUpdate('trade_bitget');
        });
    });

    function startAutoUpdate(url) {
        if (updateInterval) clearInterval(updateInterval);
        function update() {
            if (url === 'trade_bithumb') refreshtradeBithumb();
            else if (url === 'trade_bitget') refreshtradeBitget();
        }
        update();
        updateInterval = setInterval(update, 10000);
    }

    function updateLastUpdateTime() {
        const now = new Date();
        $('#lastUpdateTime').text(now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0') + ':' + now.getSeconds().toString().padStart(2, '0'));
    }

    // ===== 수학 계산 함수들 =====
    function getPriceRatioToday(item) {
        if(!item.price_1m) return item;
        item.price_ratio_15m = (((item.price_last - item.price_15m) / item.price_15m) * 100).toFixed(2);
        item.price_ratio_1h = (((item.price_last - item.price_1h) / item.price_1h) * 100).toFixed(2);
        item.price_ratio_4h = (((item.price_last - item.price_4h) / item.price_4h) * 100).toFixed(2);
        item.price_ratio_1d = (((item.price_last - item.price_1d) / item.price_1d) * 100).toFixed(2);
        item.price_ratio_7d = (((item.price_last - item.price_7d) / item.price_7d) * 100).toFixed(2);
        item.price_ratio_14d = (((item.price_last - item.price_14d) / item.price_14d) * 100).toFixed(2);
        item.price_ratio_high = (((item.price_last - item.price_today_high) / item.price_today_high) * 100).toFixed(2);
        item.price_ratio_high_7d = (((item.price_last - item.price_week_high) / item.price_week_high) * 100).toFixed(2);
        item.price_range_7d = (((item.price_week_high - item.price_week_low) / item.price_week_low) * 100).toFixed(2);
        return item;
    }

    function getMARatioToday(item) {
        if(!item.ma_60_10) return item;
        item.ma_ratio_60_10 = (((item.price_last - item.ma_60_10) / item.ma_60_10) * 100).toFixed(2);
        item.ma_ratio_60_20 = (((item.price_last - item.ma_60_20) / item.ma_60_20) * 100).toFixed(2);
        item.ma_ratio_60_50 = (((item.price_last - item.ma_60_50) / item.ma_60_50) * 100).toFixed(2);
        item.ma_ratio_60_100 = (((item.price_last - item.ma_60_100) / item.ma_60_100) * 100).toFixed(2);
        item.ma_ratio_60_200 = (((item.price_last - item.ma_60_200) / item.ma_60_200) * 100).toFixed(2);
        item.ma_ratio_60_400 = (((item.price_last - item.ma_60_400) / item.ma_60_400) * 100).toFixed(2);
        item.ma_ratio_60_800 = (((item.price_last - item.ma_60_800) / item.ma_60_800) * 100).toFixed(2);
        return item;
    }

    function calVolumeRatio(nu_amount, nu_cnt, de_amount, de_cnt) {
        let nu_mean = (nu_cnt !== 0) ? nu_amount / nu_cnt : 0;
        let de_mean = (de_cnt !== 0) ? de_amount / de_cnt : 0;
        return (de_mean === 0) ? 0 : (nu_mean / de_mean) - 1;
    }

    function getVolumeRatioToday(item) {
        item.volume_ratio_1m_60m = (calVolumeRatio(item.amount_1m, item.count_1m, item.amount_60m, item.count_60m) * 100).toFixed(1);
        item.volume_ratio_5m_60m = (calVolumeRatio(item.amount_5m, item.count_5m, item.amount_60m, item.count_60m) * 100).toFixed(1);
        return item;
    }

    async function loadUserMemos(exchange) {
        try {
            const response = await fetch('trade_bitget/user-memos');
            const data = await response.json();
            favoritesCache[exchange] = data.favorites || [];
            memosCache[exchange] = data.memos || {};
            visitCache[exchange] = data.visits || {};
            return data;
        } catch (error) { return { favorites: [], memos: {}, visits: {} }; }
    }

    async function updateUserMemo(market, updates) {
        try {
            const formData = new FormData();
            formData.append('market', market);
            if ('favorite' in updates) formData.append('favorite', updates.favorite);
            if ('memo' in updates) formData.append('memo', updates.memo);
            if ('last_visited_at' in updates) formData.append('last_visited_at', updates.last_visited_at);
            const response = await fetch('trade_bitget/user-memos/update', { method: 'POST', body: formData });
            const data = await response.json();
            if (data.status === 'success') {
                const exchange = 'bitget';
                if ('favorite' in data) {
                    if (data.favorite) { if (!favoritesCache[exchange].includes(market)) favoritesCache[exchange].push(market); }
                    else { const index = favoritesCache[exchange].indexOf(market); if (index > -1) favoritesCache[exchange].splice(index, 1); }
                }
                if ('memo' in data) memosCache[exchange][market] = data.memo;
                if ('last_visited_at' in data) visitCache[exchange][market] = data.last_visited_at;
            }
            return data;
        } catch (error) { return null; }
    }

    async function toggleFavorite(exchange, market) {
        const currentStatus = getFavoriteStatus(exchange, market);
        const result = await updateUserMemo(market, { favorite: !currentStatus });
        return result ? result.favorite : currentStatus;
    }

    function getFavoriteStatus(exchange, market) { return (favoritesCache[exchange] || []).includes(market); }
    function getMemo(exchange, market) { return (memosCache[exchange] || {})[market] || ''; }
    function getVisitDate(exchange, market) { return (visitCache[exchange] || {})[market] || ''; }

    async function saveVisitDate(exchange, market, dateString) {
        if (!visitCache[exchange]) visitCache[exchange] = {};
        visitCache[exchange][market] = dateString;
        await updateUserMemo(market, { last_visited_at: dateString });
        if (gridApitradeBitget) {
            const rowNode = gridApitradeBitget.getRowNode(market);
            if (rowNode) rowNode.setDataValue('last_visited_at', dateString);
        }
    }

    let memoSaveTimeout = null;
    async function saveMemo(exchange, market, memo) {
        if (!memosCache[exchange]) memosCache[exchange] = {};
        memosCache[exchange][market] = memo;
        clearTimeout(memoSaveTimeout);
        memoSaveTimeout = setTimeout(async () => { await updateUserMemo(market, { memo: memo }); }, 500);
    }

    function refreshtradeBithumb() {
        $.ajax({
            url: "{% url 'bithumb:trade_bithumb' %}",
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            success: function(response) {
                const processedData = (response['data'] || []).map(item => {
                    item = getPriceRatioToday(item);
                    item = getMARatioToday(item);
                    item = getVolumeRatioToday(item);
                    return {
                        market: item.market, price: item.price_last, capitalization: item.capitalization,
                        price_ratio_5m: parseFloat(item.price_ratio_5m), price_ratio_30m: parseFloat(item.price_ratio_30m),
                        price_ratio_60m: parseFloat(item.price_ratio_60m), price_ratio_240m: parseFloat(item.price_ratio_240m),
                        price_ratio_high: parseFloat(item.price_ratio_high), price_ratio_low: parseFloat(item.price_ratio_low),
                        price_ratio_1d: parseFloat(item.price_ratio_1d), price_ratio_7d: parseFloat(item.price_ratio_7d),
                        ma_ratio_60_10: parseFloat(item.ma_ratio_60_10), ma_ratio_60_50: parseFloat(item.ma_ratio_60_50),
                        ma_ratio_60_200: parseFloat(item.ma_ratio_60_200), ma_ratio_day_10: parseFloat(item.ma_ratio_day_10),
                        ma_ratio_day_50: parseFloat(item.ma_ratio_day_50), ma_ratio_day_200: parseFloat(item.ma_ratio_day_200)
                    };
                });
                if (!gridApitradeBithumb.getDisplayedRowCount()) gridApitradeBithumb.setGridOption('rowData', processedData);
                else gridApitradeBithumb.applyTransaction({ update: processedData });
                updateLastUpdateTime();
            }
        });
    }

    function refreshtradeBitget() {
        $.ajax({
            url: "{% url 'bithumb:trade_bitget' %}",
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            success: function(response) {
                const processedData = (response['data'] || []).filter(item => item.price_last).map(item => {
                    item = getPriceRatioToday(item);
                    item = getMARatioToday(item);
                    return {
                        market: item.market, price: item.price_last, volume: item.volume, funding_rate: item.funding_rate,
                        price_ratio_15m: parseFloat(item.price_ratio_15m), price_ratio_1h: parseFloat(item.price_ratio_1h),
                        price_ratio_4h: parseFloat(item.price_ratio_4h), price_ratio_1d: parseFloat(item.price_ratio_1d),
                        price_ratio_7d: parseFloat(item.price_ratio_7d), price_ratio_14d: parseFloat(item.price_ratio_14d),
                        price_range_7d: parseFloat(item.price_range_7d), price_ratio_high: parseFloat(item.price_ratio_high),
                        price_ratio_high_7d: parseFloat(item.price_ratio_high_7d), ma_ratio_60_10: parseFloat(item.ma_ratio_60_10),
                        ma_ratio_60_20: parseFloat(item.ma_ratio_60_20), ma_ratio_60_50: parseFloat(item.ma_ratio_60_50),
                        ma_ratio_60_100: parseFloat(item.ma_ratio_60_100), ma_ratio_60_200: parseFloat(item.ma_ratio_60_200),
                        ma_ratio_60_400: parseFloat(item.ma_ratio_60_400), ma_ratio_60_800: parseFloat(item.ma_ratio_60_800),
                        last_visited_at: getVisitDate('bitget', item.market)
                    };
                });
                if (!gridApitradeBitget.getDisplayedRowCount()) gridApitradeBitget.setGridOption('rowData', processedData);
                else gridApitradeBitget.applyTransaction({ update: processedData });
                updateLastUpdateTime();
            }
        });
    }
</script>
{% endblock %}