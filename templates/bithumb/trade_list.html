{% extends "base.html" %}

{% block content %}

<!-- AG Grid CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine-dark.css">

<style>
    :root {
        --bg-primary: #0b0e11;
        --bg-secondary: #1e2329;
        --bg-hover: #2b3139;
        --border-color: #2b3139;
        --text-primary: #eaecef;
        --text-secondary: #848e9c;
        --positive: #0ecb81;
        --negative: #f6465d;
        --accent: #fcd535;
    }

    body {
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .table-container {
        margin: 0;
        padding: 20px;
        background: var(--bg-primary);
    }

    /* 탭 스타일 */
    .nav-tabs {
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-secondary);
        padding: 0 20px;
    }

    .nav-tabs .nav-link {
        color: var(--text-secondary);
        border: none;
        padding: 16px 24px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        border-bottom: 2px solid transparent;
    }

    .nav-tabs .nav-link:hover {
        color: var(--text-primary);
        background: rgba(255, 255, 255, 0.02);
    }

    .nav-tabs .nav-link.active {
        color: var(--accent);
        background: transparent;
        border-bottom: 2px solid var(--accent);
    }

    /* AG Grid 커스텀 스타일 */
    .ag-theme-alpine-dark {
        --ag-background-color: #1e2329;
        --ag-header-background-color: #0b0e11;
        --ag-odd-row-background-color: #1e2329;
        --ag-header-foreground-color: #848e9c;
        --ag-foreground-color: #eaecef;
        --ag-border-color: #2b3139;
        --ag-row-hover-color: #2b3139;
        --ag-selected-row-background-color: #2b3139;
        --ag-font-size: 13px;
        --ag-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .ag-grid-container {
        height: 600px;
        width: 100%;
        margin: 20px 0;
    }

    .ag-header-cell-text {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 12px;
    }

    .ag-cell {
        display: flex;
        align-items: center;
    }

    /* 가격 변동 스타일 */
    .positive {
        color: var(--positive) !important;
        font-weight: 600;
    }

    .negative {
        color: var(--negative) !important;
        font-weight: 600;
    }

    .percent-box {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    .percent-box.positive {
        background: rgba(14, 203, 129, 0.1);
        color: var(--positive);
    }

    .percent-box.negative {
        background: rgba(246, 70, 93, 0.1);
        color: var(--negative);
    }

    .market-link {
        color: var(--text-primary);
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s;
    }

    .market-link:hover {
        color: var(--accent);
    }

    /* 셀 플래시 애니메이션 (데이터 변경 시) */
    .ag-cell-data-changed {
        background-color: rgba(252, 213, 53, 0.3) !important;
    }
    
    .ag-cell-data-changed-animation {
        background-color: transparent;
        transition: background-color 1s;
    }

    /* 로딩 스피너 */
    .loading-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(11, 14, 17, 0.95);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        margin-top: 20px;
        color: var(--text-secondary);
        font-size: 14px;
    }

    /* 업데이트 정보 */
    .update-info,
    .timer-container {
        color: var(--text-secondary);
        font-size: 12px;
        padding: 12px 20px;
        background: var(--bg-secondary);
    }

    .update-info span {
        color: var(--accent);
        font-weight: 600;
    }

    /* 반응형 */
    @media (max-width: 768px) {
        .ag-grid-container {
            height: 500px;
        }
    }
</style>

<div id="bithumb-contents">
    <div id="trade_list">
        <!-- 탭 메뉴 -->
        <ul class="nav nav-tabs" id="tradeTab" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="trade_info_tab" data-toggle="tab" href="#trade_info_contents" role="tab">
                    기본정보
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="trade_day_tab" data-toggle="tab" href="#trade_day_contents" role="tab">
                    단타
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="trade_swing_tab" data-toggle="tab" href="#trade_swing_contents" role="tab">
                    스윙
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="trade_timetable_tab" data-toggle="tab" href="#trade_timetable_contents" role="tab">
                    시간대별(수정중)
                </a>
            </li>
        </ul>

        <!-- 로딩 컨테이너 -->
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">데이터를 불러오는 중입니다...</div>
        </div>

        <!-- 업데이트 정보 -->
        <div class="timer-container">
            데이터는 10초에 한번씩 자동으로 업데이트됩니다.
        </div>
        <div class="update-info">
            마지막 업데이트: <span id="lastUpdateTime">-</span>
        </div>

        <!-- 탭 컨텐츠 -->
        <div class="tab-content" id="tradeTabContent">
            <div class="tab-pane fade" id="trade_info_contents" role="tabpanel">
                <div id="gridTradeInfo" class="ag-theme-alpine-dark ag-grid-container"></div>
            </div>
            <div class="tab-pane fade show active" id="trade_day_contents" role="tabpanel">
                <div id="gridTradeToday" class="ag-theme-alpine-dark ag-grid-container"></div>
            </div>
            <div class="tab-pane fade" id="trade_swing_contents" role="tabpanel">
                <div id="gridTradeSwing" class="ag-theme-alpine-dark ag-grid-container"></div>
            </div>
            <div class="tab-pane fade" id="trade_timetable_contents" role="tabpanel">
                <div id="gridTradeTimetable" class="ag-theme-alpine-dark ag-grid-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- AG Grid JS -->
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>

<script type="text/javascript">
    let gridApiTradeInfo;
    let gridApiTradeToday;
    let gridApiTradeSwing;
    let gridApiTradeTimetable;
    let updateInterval;

    // 공통 Cell Renderers
    class MarketCellRenderer {
        init(params) {
            this.eGui = document.createElement('a');
            this.eGui.href = `https://www.bithumb.com/react/trade/order/${params.value}-KRW`;
            this.eGui.target = '_blank';
            this.eGui.className = 'market-link';
            this.eGui.textContent = params.value;
        }
        getGui() {
            return this.eGui;
        }
    }

    class PercentCellRenderer {
        init(params) {
            this.eGui = document.createElement('span');
            const value = parseFloat(params.value);
            const absValue = Math.abs(value).toFixed(1);
            const displayValue = value > 0 ? `+${absValue}` : `-${absValue}`;
            
            this.eGui.className = value > 0 ? 'percent-box positive' : 'percent-box negative';
            this.eGui.textContent = `${displayValue}%`;
        }
        getGui() {
            return this.eGui;
        }
    }

    class PriceCellRenderer {
        init(params) {
            this.eGui = document.createElement('span');
            this.eGui.textContent = Number(params.value).toLocaleString();
        }
        getGui() {
            return this.eGui;
        }
    }

    // 단타 그리드 설정
    const columnDefsTradeToday = [
        { 
            field: 'market', 
            headerName: '종목', 
            width: 120,
            pinned: 'left',
            cellRenderer: MarketCellRenderer,
            sortable: true,
            filter: true
        },
        { 
            field: 'price', 
            headerName: '현재가', 
            width: 120,
            cellRenderer: PriceCellRenderer,
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'price_ratio_5m', 
            headerName: '5분', 
            width: 100,
            cellRenderer: PercentCellRenderer,
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'price_ratio_30m', 
            headerName: '30분', 
            width: 100,
            cellRenderer: PercentCellRenderer,
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'price_ratio_60m', 
            headerName: '60분', 
            width: 100,
            cellRenderer: PercentCellRenderer,
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'price_ratio_240m', 
            headerName: '240분', 
            width: 100,
            cellRenderer: PercentCellRenderer,
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'price_ratio_high', 
            headerName: '고점대비', 
            width: 110,
            cellRenderer: PercentCellRenderer,
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'price_ratio_low', 
            headerName: '저점대비', 
            width: 110,
            cellRenderer: PercentCellRenderer,
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'ma_ratio_60_10', 
            headerName: 'MA_60_10', 
            width: 120,
            cellRenderer: PercentCellRenderer,
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'ma_ratio_60_20', 
            headerName: 'MA_60_20', 
            width: 120,
            cellRenderer: PercentCellRenderer,
            sortable: true,
            type: 'numericColumn'
        }
    ];

    // 스윙 그리드 설정
    const columnDefsTradeSwing = [
        { 
            field: 'market', 
            headerName: '종목', 
            width: 120,
            pinned: 'left',
            cellRenderer: MarketCellRenderer,
            sortable: true,
            filter: true
        },
        { 
            field: 'korean_name', 
            headerName: '이름', 
            width: 120,
            sortable: true
        },
        { 
            field: 'capitalization', 
            headerName: '시가총액', 
            width: 130,
            valueFormatter: params => `${Number(params.value).toLocaleString()}억`,
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'kimchi_premium', 
            headerName: '김프', 
            width: 100,
            cellRenderer: PercentCellRenderer,
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'price_1m', 
            headerName: '현재가', 
            width: 120,
            cellRenderer: PriceCellRenderer,
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'price_ratio_day', 
            headerName: '1일', 
            width: 100,
            cellRenderer: PercentCellRenderer,
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'price_ratio_3days', 
            headerName: '3일', 
            width: 100,
            cellRenderer: PercentCellRenderer,
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'price_ratio_week', 
            headerName: '7일', 
            width: 100,
            cellRenderer: PercentCellRenderer,
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'price_ratio_month', 
            headerName: '30일', 
            width: 100,
            cellRenderer: PercentCellRenderer,
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'rsi_240m', 
            headerName: 'RSI 4H', 
            width: 100,
            valueFormatter: params => params.value.toFixed(1),
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'rsi_day', 
            headerName: 'RSI 1D', 
            width: 100,
            valueFormatter: params => params.value.toFixed(1),
            sortable: true,
            type: 'numericColumn'
        }
    ];

    // 기본정보 그리드 설정
    const columnDefsTradeInfo = [
        { 
            field: 'market', 
            headerName: '종목', 
            width: 120,
            pinned: 'left',
            cellRenderer: MarketCellRenderer,
            sortable: true,
            filter: true
        },
        { 
            field: 'korean_name', 
            headerName: '이름', 
            width: 150,
            sortable: true
        },
        { 
            field: 'capitalization', 
            headerName: '시가총액', 
            width: 130,
            valueFormatter: params => `${(params.value / 100000000).toLocaleString()}억`,
            sortable: true,
            type: 'numericColumn'
        },
        { 
            field: 'supply_ratio', 
            headerName: '발행률', 
            width: 100,
            sortable: true
        },
        { 
            field: 'listing_month', 
            headerName: '상장일', 
            width: 120,
            sortable: true
        },
        { 
            field: 'chain', 
            headerName: '체인', 
            width: 120,
            sortable: true,
            filter: true
        },
        { 
            field: 'category', 
            headerName: '카테고리', 
            width: 130,
            sortable: true,
            filter: true
        },
        { 
            field: 'description', 
            headerName: '설명', 
            flex: 1,
            minWidth: 200,
            wrapText: true,
            autoHeight: true
        }
    ];

    // Grid Options
    const defaultGridOptions = {
        defaultColDef: {
            sortable: true,
            resizable: true,
            filter: false
        },
        animateRows: true,
        rowSelection: 'single',
        enableCellTextSelection: true,
        suppressCellFocus: true,
        // Row ID를 통한 효율적인 업데이트
        getRowId: params => params.data.market,
        // 셀 플래시 애니메이션 (변경된 셀만 강조)
        enableCellChangeFlash: true,
        // 부드러운 애니메이션
        animateRows: true,
        getRowStyle: params => {
            if (params.node.rowIndex % 2 === 0) {
                return { background: '#1e2329' };
            }
        }
    };

    $(document).ready(function() {
        // 단타 그리드 초기화
        const gridDivTradeToday = document.querySelector('#gridTradeToday');
        gridApiTradeToday = agGrid.createGrid(gridDivTradeToday, {
            ...defaultGridOptions,
            columnDefs: columnDefsTradeToday,
            rowData: []
        });

        startAutoUpdate('trade_day');

        // 탭 클릭 이벤트
        $('#trade_info_tab').on('click', function() {
            stopAutoUpdate();
            if (!gridApiTradeInfo) {
                const gridDiv = document.querySelector('#gridTradeInfo');
                gridApiTradeInfo = agGrid.createGrid(gridDiv, {
                    ...defaultGridOptions,
                    columnDefs: columnDefsTradeInfo,
                    rowData: []
                });
            }
            refreshTradeInfo();
        });

        $('#trade_day_tab').on('click', function() {
            startAutoUpdate('trade_day');
        });

        $('#trade_swing_tab').on('click', function() {
            if (!gridApiTradeSwing) {
                const gridDiv = document.querySelector('#gridTradeSwing');
                gridApiTradeSwing = agGrid.createGrid(gridDiv, {
                    ...defaultGridOptions,
                    columnDefs: columnDefsTradeSwing,
                    rowData: []
                });
            }
            startAutoUpdate('trade_swing');
        });

        $('#trade_timetable_tab').on('click', function() {
            if (!gridApiTradeTimetable) {
                const gridDiv = document.querySelector('#gridTradeTimetable');
                gridApiTradeTimetable = agGrid.createGrid(gridDiv, {
                    ...defaultGridOptions,
                    columnDefs: [],
                    rowData: []
                });
            }
            startAutoUpdate('trade_timetable', 1);
        });
    });

    function stopAutoUpdate() {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    }

    function startAutoUpdate(url, parameter) {
        stopAutoUpdate();
        
        function update() {
            if (url === 'trade_day') {
                refreshTradeToday();
            } else if (url === 'trade_swing') {
                refreshTradeSwing();
            } else if (url === 'trade_timetable') {
                refreshTradeTimetable(parameter);
            }
        }
        
        // 첫 로드만 로딩 표시
        if (url === 'trade_day' && !gridApiTradeToday.getDisplayedRowCount()) {
            showLoading();
            setTimeout(() => {
                update();
                hideLoading();
            }, 100);
        } else if (url === 'trade_swing' && gridApiTradeSwing && !gridApiTradeSwing.getDisplayedRowCount()) {
            showLoading();
            setTimeout(() => {
                update();
                hideLoading();
            }, 100);
        } else {
            update();
        }
        
        updateInterval = setInterval(update, 10000);
    }

    function showLoading() {
        $('.loading-container').css('display', 'flex');
    }

    function hideLoading() {
        $('.loading-container').css('display', 'none');
    }

    function updateLastUpdateTime() {
        const now = new Date();
        const timeString = now.getHours().toString().padStart(2, '0') + ':' +
                          now.getMinutes().toString().padStart(2, '0') + ':' +
                          now.getSeconds().toString().padStart(2, '0');
        $('#lastUpdateTime').text(timeString);
    }

    function getPriceRatioToday(item) {
        item.price_ratio_5m = (((item.price_last - item.price_5m) / item.price_5m) * 100).toFixed(2);
        item.price_ratio_30m = (((item.price_last - item.price_30m) / item.price_30m) * 100).toFixed(2);
        item.price_ratio_60m = (((item.price_last - item.price_60m) / item.price_60m) * 100).toFixed(2);
        item.price_ratio_240m = (((item.price_last - item.price_240m) / item.price_240m) * 100).toFixed(2);
        item.price_ratio_high = (((item.price_last - item.price_today_high) / item.price_today_high) * 100).toFixed(2);
        item.price_ratio_low = (((item.price_last - item.price_today_low) / item.price_today_low) * 100).toFixed(2);

        
        return item;
    }

    function getMARatioToday(item) {
        // ma_ratio_60_10을 8가지 기간으로 확장
        item.ma_ratio_60_10 = (((item.price_last - item.ma_60_10) / item.ma_60_10) * 100).toFixed(2);
        item.ma_ratio_60_20 = (((item.price_last - item.ma_60_20) / item.ma_60_20) * 100).toFixed(2);
        item.ma_ratio_60_34 = (((item.price_last - item.ma_60_34) / item.ma_60_34) * 100).toFixed(2);
        item.ma_ratio_60_50 = (((item.price_last - item.ma_60_50) / item.ma_60_50) * 100).toFixed(2);
        item.ma_ratio_60_100 = (((item.price_last - item.ma_60_100) / item.ma_60_100) * 100).toFixed(2);
        item.ma_ratio_60_200 = (((item.price_last - item.ma_60_200) / item.ma_60_200) * 100).toFixed(2);
        item.ma_ratio_60_400 = (((item.price_last - item.ma_60_400) / item.ma_60_400) * 100).toFixed(2);
        item.ma_ratio_60_800 = (((item.price_last - item.ma_60_800) / item.ma_60_800) * 100).toFixed(2);


        // ma_ratio_day_10을 6가지 기간으로 확장 (200까지만)
        item.ma_ratio_day_10 = (((item.price_last - item.ma_day_10) / item.day_10) * 100).toFixed(2);
        item.ma_ratio_day_20 = (((item.price_last - item.ma_day_20) / item.day_20) * 100).toFixed(2);
        item.ma_ratio_day_34 = (((item.price_last - item.ma_day_34) / item.day_34) * 100).toFixed(2);
        item.ma_ratio_day_50 = (((item.price_last - item.ma_day_50) / item.day_50) * 100).toFixed(2);
        item.ma_ratio_day_100 = (((item.price_last - item.ma_day_100) / item.day_100) * 100).toFixed(2);
        item.ma_ratio_day_200 = (((item.price_last - item.ma_day_200) / item.day_200) * 100).toFixed(2);
        

        
        return item;
    }

    function calVolumeRatio(nu_amount, nu_cnt, de_amount, de_cnt) {
        let nu_mean = 0;
        let de_mean = 0;
        if (nu_cnt !== 0) { nu_mean = nu_amount / nu_cnt; }
        if (de_cnt !== 0) { de_mean = de_amount / de_cnt; }
        if (de_mean === 0) { return 0; }
        return (nu_mean / de_mean) - 1;
    }

    function getVolumeRatioToday(item) {
        item.volume_ratio_1m_60m = (calVolumeRatio(item.amount_1m, item.count_1m, item.amount_60m, item.count_60m) * 100).toFixed(1);
        item.volume_ratio_5m_60m = (calVolumeRatio(item.amount_5m, item.count_5m, item.amount_60m, item.count_60m) * 100).toFixed(1);
        item.volume_ratio_10m_60m = (calVolumeRatio(item.amount_10m, item.count_10m, item.amount_60m, item.count_60m) * 100).toFixed(1);
        return item;
    }

    function refreshTradeToday() {
        // 로딩 표시 제거 (업데이트 시 깜빡임 방지)
        $.ajax({
            url: "{% url 'bithumb:trade_day' %}",
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {

                console.log(response['data'])
                const processedData = response['data'].map(item => {
                    item = getPriceRatioToday(item);
                    item = getMARatioToday(item);
                    item = getVolumeRatioToday(item);
                    return {
                        market: item.market,
                        price: item.price_last,
                        price_ratio_5m: parseFloat(item.price_ratio_5m),
                        price_ratio_30m: parseFloat(item.price_ratio_30m),
                        price_ratio_60m: parseFloat(item.price_ratio_60m),
                        price_ratio_240m: parseFloat(item.price_ratio_240m),
                        price_ratio_high: parseFloat(item.price_ratio_high),
                        price_ratio_low: parseFloat(item.price_ratio_low),
                        // ma_ratio_60_N 비율 변환
                        ma_ratio_60_10: parseFloat(item.ma_ratio_60_10),
                        ma_ratio_60_20: parseFloat(item.ma_ratio_60_20),
                        ma_ratio_60_34: parseFloat(item.ma_ratio_60_34),
                        ma_ratio_60_50: parseFloat(item.ma_ratio_60_50),
                        ma_ratio_60_100: parseFloat(item.ma_ratio_60_100),
                        ma_ratio_60_200: parseFloat(item.ma_ratio_60_200),
                        ma_ratio_60_400: parseFloat(item.ma_ratio_60_400),
                        ma_ratio_60_800: parseFloat(item.ma_ratio_60_800),

                        // ma_ratio_day_N 비율 변환 (200까지만)
                        ma_ratio_day_10: parseFloat(item.ma_ratio_day_10),
                        ma_ratio_day_20: parseFloat(item.ma_ratio_day_20),
                        ma_ratio_day_34: parseFloat(item.ma_ratio_day_34),
                        ma_ratio_day_50: parseFloat(item.ma_ratio_day_50),
                        ma_ratio_day_100: parseFloat(item.ma_ratio_day_100),
                        ma_ratio_day_200: parseFloat(item.ma_ratio_day_200),

                    };
                });

                // applyTransaction으로 효율적 업데이트
                const updateTransaction = {
                    update: processedData
                };
                
                // 첫 로드인 경우 전체 데이터 설정
                if (!gridApiTradeToday.getDisplayedRowCount()) {
                    gridApiTradeToday.setGridOption('rowData', processedData);
                } else {
                    // 이후 업데이트는 트랜잭션으로 처리
                    gridApiTradeToday.applyTransaction(updateTransaction);
                }
                
                updateLastUpdateTime();
            },
            error: function(err) {
                console.error("데이터 가져오기 실패:", err);
            }
        });
    }

    function refreshTradeSwing() {
        $.ajax({
            url: "{% url 'bithumb:trade_swing' %}",
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                const processedData = response['data'].map(item => {
                    return {
                        market: item.market,
                        korean_name: item.korean_name,
                        capitalization: item.capitalization / 100000000,
                        kimchi_premium: parseFloat(item.kimchi_premium),
                        price_1m: item.price_1m,
                        price_ratio_day: parseFloat((((item.price_1m - item.price_day) / item.price_day) * 100).toFixed(2)),
                        price_ratio_3days: parseFloat((((item.price_1m - item.price_3days) / item.price_3days) * 100).toFixed(2)),
                        price_ratio_week: parseFloat((((item.price_1m - item.price_week) / item.price_week) * 100).toFixed(2)),
                        price_ratio_month: parseFloat((((item.price_1m - item.price_month) / item.price_month) * 100).toFixed(2)),
                        rsi_240m: item.rsi_240m,
                        rsi_day: item.rsi_day
                    };
                });

                // 효율적 업데이트
                if (!gridApiTradeSwing.getDisplayedRowCount()) {
                    gridApiTradeSwing.setGridOption('rowData', processedData);
                } else {
                    gridApiTradeSwing.applyTransaction({ update: processedData });
                }
                
                updateLastUpdateTime();
            },
            error: function(err) {
                console.error("데이터 가져오기 실패:", err);
            }
        });
    }

    function refreshTradeInfo() {
        $.ajax({
            url: "{% url 'bithumb:trade_info' %}",
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                const processedData = response['data'].map(item => {
                    return {
                        market: item.market,
                        korean_name: item.korean_name,
                        capitalization: item.capitalization,
                        supply_ratio: !item.max_supply ? '-' : `${((item.now_supply / item.max_supply) * 100).toFixed(1)}%`,
                        listing_month: item.listing_month,
                        chain: item.chain,
                        category: item.category,
                        description: item.description
                    };
                });

                gridApiTradeInfo.setGridOption('rowData', processedData);
                updateLastUpdateTime();
            },
            error: function(err) {
                console.error("데이터 가져오기 실패:", err);
            }
        });
    }

    function refreshTradeTimetable(hours) {
        $.ajax({
            url: "{% url 'bithumb:trade_timetable' %}",
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            data: {
                'hours': hours
            },
            success: function(response) {
                // 동적으로 컬럼 생성
                const timeColumns = [
                    { field: 'market', headerName: '종목', width: 120, pinned: 'left', cellRenderer: MarketCellRenderer, sortable: true, filter: true },
                    { field: 'korean_name', headerName: '이름', width: 120, sortable: true },
                    { field: 'price_1m', headerName: '현재가', width: 120, cellRenderer: PriceCellRenderer, sortable: true, type: 'numericColumn' }
                ];
                
                // 시간대별 컬럼 추가 (d0 ~ d11)
                for (let i = 0; i < 12; i++) {
                    const hour = (new Date().getHours() - i + 24) % 24;
                    timeColumns.push({
                        field: `d${i}`,
                        headerName: `${hour}시`,
                        width: 90,
                        valueFormatter: params => `${(params.value / 100000000).toFixed(1)}억`,
                        sortable: true,
                        type: 'numericColumn'
                    });
                }
                
                gridApiTradeTimetable.setGridOption('columnDefs', timeColumns);
                gridApiTradeTimetable.setGridOption('rowData', response['data']);
                updateLastUpdateTime();
            },
            error: function(err) {
                console.error("데이터 가져오기 실패:", err);
            }
        });
    }
</script>
{% endblock %}